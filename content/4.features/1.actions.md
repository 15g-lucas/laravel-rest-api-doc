# Actions

## Introduction

Actions is a way to provide actions for your users with a full integration in Laravel Rest Api, it includes the strong search feature to enable security and power.

Your resource automatically exposes the actions you have defined on it. Configure it, register it and you are done !

## Overview

Actions can be generated using the `rest:action` Artisan command. All actions are places by default in your `App\Rest\Actions` directory.

```bash
php artisan rest:action SendWelcomeNotificationAction
```

You are now ready to configure your action:

```php
namespace App\Rest\Actions;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;
use Lomkit\Rest\Actions\Action;
use Lomkit\Rest\Http\Requests\RestRequest;

class SendWelcomeNotificationAction extends Action
{
    /**
     * Perform the action on the given models.
     *
     * @param  array  $fields
     * @param  \Illuminate\Support\Collection  $models
     * @return mixed
     */
    public function handle(array $fields, \Illuminate\Support\Collection $models)
    {
        foreach ($models as $model) {
            $model->notify(new \App\Notifications\SendWelcomeNotification($fields['expires_at']));
        }
    }

    /**
     * Called in an action failed.
     *
     * @param  \Lomkit\Rest\Http\Requests\RestRequest $request
     * @return array
     */
    public function fields(\Lomkit\Rest\Http\Requests\RestRequest $request)
    {
        return [
            'expires_at' => [
                'required', 'date'
            ]
        ];
    }
}
```

In the `handle` method you receive a Collection of models, the models corresponds to the resource the action has been registered on.
You are free to do whatever you want in this handle method: update records, send jobs, ...

## Fields

Sometimes, you want to collect data directly from your frontend users this is what fields are made for. You first need to define them in your action:

```php
namespace App\Rest\Actions;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;
use Lomkit\Rest\Actions\Action;
use Lomkit\Rest\Http\Requests\RestRequest;

class SendWelcomeNotificationAction extends Action
{
     /**
     * Called in an action failed.
     *
     * @param  \Lomkit\Rest\Http\Requests\RestRequest $request
     * @return array
     */
    public function fields(\Lomkit\Rest\Http\Requests\RestRequest $request)
    {
        return [
            'expires_at' => [
                'required', 'date'
            ]
        ];
    }
}
```

In the array returned, the key must be the name of the field given in the call. The value is the list of validation you want to provide for the field.
Laravel Rest Api automatically validates all fields using your validation rules.

You get those fields in the `$field` variable in your `handle` method.

## Queued actions

If your actions need much time to operate, you might want to queue your actions. To instruct Laravel Rest Api to queue your action at runtime, you should use the `ShouldQueue` interface:

```php
namespace App\Rest\Actions;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;
use Lomkit\Rest\Actions\Action;
use Illuminate\Contracts\Queue\ShouldQueue;
use Lomkit\Rest\Http\Requests\RestRequest;

class SendWelcomeNotificationAction extends Action implements ShouldQueue
{
    // ...
}
```

Laravel Rest Api will chunk your results and create a job for each chunk. By default, the chunk size is set to `100`,
 if you wish to change this, declare the `chunkCount property on your model:

```php
namespace App\Rest\Actions;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;
use Lomkit\Rest\Actions\Action;
use Illuminate\Contracts\Queue\ShouldQueue;
use Lomkit\Rest\Http\Requests\RestRequest;

class SendWelcomeNotificationAction extends Action implements ShouldQueue
{
    /**
     * The number of models that should be included in each chunk.
     *
     * @var int
     */
    public $chunkCount = 100;
}
```

::alert{type="info"}
Chunking is also done when you are not using queue, the `handle` method will be called directly for each chunk.
::

### Customising the queue and connection

You may customize the queue connection and queue name that the action is queued on by setting the $connection and $queue properties on your class:

```php

namespace App\Rest\Actions;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;
use Lomkit\Rest\Actions\Action;
use Illuminate\Contracts\Queue\ShouldQueue;
use Lomkit\Rest\Http\Requests\RestRequest;

class SendWelcomeNotificationAction extends Action implements ShouldQueue
{
    /**
     * The name of the connection the job should be sent to.
     *
     * @var string|null
     */
    public $connection;

    /**
     * The name of the queue the job should be sent to.
     *
     * @var string|null
     */
    public $queue;
}
```

### Callbacks

#### Success

COMING NEXT WEEK :)

#### Failed

You can use the `failed` function in your action to interacts with an interaction failing:

```php[SendWelcomeNotificationAction.php]
    /**
     * Called in an action failed.
     *
     * @param  \Exception $exception
     * @param  array  $fields
     * @param  \Illuminate\Support\Collection  $models
     * @return mixed
     */
    public function failed(array $fields, Collection $models, $exception)
    {
        // Send mail, ...
    }
```
