# Search

## Introduction

Laravel Rest Api exposes the search endpoint which is dedicated to access data for your frontend users.

## Usage

Here is a quick look at what you can do:

```php
// (POST) api/posts/search
{
    "scopes": [
        {"name": "withTrashed", "parameters": [true]}
    ],
    "filters": [
        {
            "field": "id", "operator": ">", "value": 1, "type": "or"
        },
        {
            "nested": [
                {"field": "user.id", "operator": "<", "value": 2},
                {"field": "id", "operator": ">", "value": 100, "type": "or"}
            ]
        }
    ],
    "sorts": [
        {"field": "user_id", "direction": "desc"},
        {"field": "id", "direction": "asc"}
    ],
    "selects": [
        {"field": "id"}
    ],
    "includes": [
        {
            "relation": "posts",
            "filters": [
                 {"field": "id", "operator": "in", "value": [1, 3]}
            ],
            "limit": 2
        },
        {
            "relation": "user",
            "filters": [
                {
                    "field": "languages.pivot.boolean",
                    "operator": "=",
                    "value": true
                }
            ]
        }
    ],
    "aggregates": [
        {
            "relation": "stars",
            "type": "max",
            "max": "rate",
            "filters": [
                {"field": "approved", "value": true}
            ]
        },
    ],
    "page": 2,
    "limit": 10
}
```

### Specifications
| **Key**               | **Type** | **Required**                          | **Default** | **Description**                                                                                                |
|-----------------------|----------|---------------------------------------|-------------|----------------------------------------------------------------------------------------------------------------|
| **Scopes**            |          |                                       |             |                                                                                                                |
| `scopes.name`         | `string` | X                                     |             | The name of the scope                                                                                          |
| `scopes.parameters`   | `array`  |                                       |             | The parameters associated with the scope                                                                       |
| **Filters**           |          |                                       |             |                                                                                                                |
| `filters.field`       | `string` | when not nested                       |             | The name of the field                                                                                          |
| `filters.operator`    | `string` |                                       | `=`         | The field operator                                                                                             |
| `filters.value`       | `mixed`  | when not nested                       |             | The value you want to filter with                                                                              |
| `filters.type`        | `string` |                                       | `and`       | The filter condition type                                                                                      |
| `filters.nested`      | `array`  |                                       |             | The nested parameters                                                                                          |
| **Sorts**             |          |                                       |             |                                                                                                                |
| `sorts.field`         | `string` | X                                     |             | The name of the field                                                                                          |
| `sorts.direction`     | `string` |                                       | `asc`       | The direction which it should be sorted                                                                        |
| **Selects**           |          |                                       |             |                                                                                                                |
| `selects.field`       | `string` | X                                     |             | The name of the field                                                                                          |
| **Includes**          |          |                                       |             |                                                                                                                |
| `includes.relation`   | `string` | X                                     |             | The relation you are querying                                                                                  |
| `includes.other`      | `mixed`  |                                       | `50`        | You can specify all the arguments in the current page such as `filters`, `limit`, `scopes`, etc except include |
| **Aggregates**        |          |                                       |             |                                                                                                                |
| `aggregates.relation` | `string` | X                                     |             | The relation you are querying                                                                                  |
| `aggregates.type`     | `string` | X                                     |             | The type of the aggregates you want to use in: `min`, `max`, `avg`, `sum`, `count` and `exists`                |
| `aggregates.field`    | `string` | when type is not `exists` or `count`  | `*`         | The field you want to execute your aggregate on                                                                |
| `aggregates.filters`  | `array`  |                                       |             | You can specify all the arguments for the `filters` section                                                    |
| **Pagination**        |          |                                       |             |                                                                                                                |
| `page`                | `number` |                                       | 1           | The actual page                                                                                                |
| `limit`               | `number` |                                       | 50          | The maximum number of results                                                                                  |

### Scopes

Scopes corresponds to [Laravel's scopes](https://laravel.com/docs/eloquent#query-scopes). You'll first need to [specify them in your resource](/resources/exposed-datas#exposed-scopes) to allow their usage.

Use it as the following:

```php
// (POST) api/posts/search
{
    "scopes": [
        {"name": "withTrashed", "parameters": [true]}
    ]
}
```

### Filters

Filters are the way you will specify Laravel Rest Api which data you are looking for specified on fields.
All fields specified here must be before defined in the [exposedFields method of your resource](/resources/exposed-datas#exposed-fields).

Use it as the following:

```php
// (POST) api/posts/search
{
    "filters": [
        {
            "field": "id", "operator": ">", "value": 1
        }
    ]
}
```

Field is the column you want to interact with.

Operator must be in one of these:
- =
- !=
- >
- >=
- <
- <=
- like
- not like
- in
- not in

#### Distant Field

You may specify fields related to relationships by specifying the relationship(s):
```php
// (POST) api/posts/search
{
    "filters": [
        {
            "field": "languages.label",
            "operator": "=",
            "value": "fr"
        }
    ]
}
```

#### Type

In many cases you want to condition your multiple filters using an "OR" operation instead of an "AND" one.

You can achieve this by specifying the type of the filter:

```php
// (POST) api/posts/search
{
    "filters": [
        {"field": "user.id", "operator": "<", "value": 2},
        {"field": "id", "operator": ">", "value": 100, "type": "or"}
    ]
}
```

Here the query will look if the user related id is less than 2 or if the id of the post is greater than 100.

#### Pivot Filtering

When you deal with a relation that has a pivot such as the `BelongsToMany` relation, you might want to filter in the pivot table.

You can achieve this by doing:

```php
// (POST) api/posts/search
{
    "filters": [
        {
            "field": "languages.pivot.boolean",
            "operator": "=",
            "value": true
        }
    ]
}
```

#### Nested Filtering

You may want to prioritize your condition depending on the filter type because an "AND" operation takes advantage of an "OR" operation.

You can achieve this by doing:

```php
// (POST) api/posts/search
{
    "filters": [
        {
            "field": "id", "operator": "=", "value": 159, "type": "or"
        },
                {
            "field": "name", "operator": "like", "value": "%super post%", "type": "or"
        },
        {
            "nested": [
                {"field": "user.id", "operator": "<", "value": 2},
                {"field": "id", "operator": ">", "value": 100, "type": "or"}
            ]
        }
    ]
}
```

Here, Laravel Rest Api will look if the id of the posts is 159 OR the name like "%super post%" OR (the user id is less than 2 and the id of the post is greater than 100)

### Sorts

Sorts allows you to specify in which order you want to sort your results.

All fields specified here must be before defined in the [exposedFields method of your resource](/resources/exposed-datas#exposed-fields).

```php
// (POST) api/posts/search
{
    "sorts": [
        {"field": "user_id", "direction": "desc"},
        {"field": "id", "direction": "asc"}
    ]
}
```

### Selects

In some way you may want to specify the selected columns you want because it makes your API faster to not query unnecessary data.
By default, Laravel Rest Api will query all your `exposedFields`. You cannot query columns that are not present in the `exposedFields` method.

You can achieve this by doing:

```php
// (POST) api/posts/search
{
    "selects": [
        {"field": "id"},
        {"field": "title"}
    ]
}
```

### Includes

In order to limit the number of queries made to the API, Laravel Rest Api allows you to query distant relationships through a single endpoint.

You can achieve this by doing:

```php
// (POST) api/posts/search
{
    "includes": [
        {
            "relation": "posts"
        }
    ],
}
```

#### More powerful include

In order to make the include operation much more powerful, Laravel Rest Api allows to specify each arguments on this page except `include` to avoid caveats.

This allows you to do the following:

```php
// (POST) api/posts/search
{
    "includes": [
        {
            "relation": "posts",
            "filters": [
                 {"field": "id", "operator": "in", "value": [1, 3]}
            ],
            "limit": 2
        }
    ],
}
```

### Aggregates

If you don't know what an aggregate is, please have a look first at the [Laravel documentation](https://laravel.com/docs/queries#aggregates).

Laravel Rest Api supports all Laravel's aggregates, here is a quick look at how to specify your aggregate:

```php
// (POST) api/posts/search
{
    "aggregates": [
        {
            "relation": "comments",
            "type": "avg",
            "field": "stars"
        }
    ],
}
```

Here we are getting the average stars for the comments linked to the posts.

The type could be one of these:
- min
- max
- avg
- sum
- count
- exists

::alert{type="warning"}
:icon{name="ant-design:exclamation-circle-outlined" size=20}&nbsp;
For the `exists` and `count` operation you must not specify the field since these aggregates don't base themselves on a column.
::

#### Aggregates filtering

For more complex aggregates, Laravel Rest Api allows you to specify filters. These filters are the same as [the basic one](/endpoints/search#filters).

```php
// (POST) api/posts/search
{
    "aggregates": [
        {
            "relation": "comments",
            "type": "avg",
            "field": "stars",
            "filters": [
                {"field": "approved", "value": true}
            ]
        }
    ],
}
```

### Pagination

You might either want to limit the data you are querying or specifying a page to load data by sequence.
All limits specified here must be before defined in the [exposedLimits method of your resource](/resources/exposed-datas#exposed-limits).

You can achieve this by doing:

```php
// (POST) api/posts/search
{
    "page": 2,
    "limit": 10
}
```
